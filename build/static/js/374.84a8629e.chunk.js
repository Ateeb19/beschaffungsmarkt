"use strict";(self.webpackChunkbeschaffungsmarkt=self.webpackChunkbeschaffungsmarkt||[]).push([[374],{374:(e,t,a)=>{a.r(t),a.d(t,{default:()=>p});var s=a(9379),n=a(5043),c=a(3003),l=a(3172),r=a(9981),i=a(502),o=a(7706),d=a(9722),m=a(2620),h=a(3156),f=a(6720),x=a(8789),g=a(579);const u=e=>{let{accept:t,onFileDrop:a,label:c,className:l}=e;const r=(0,n.useCallback)(e=>{e.length>0&&a(e)},[a]),{getRootProps:i,getInputProps:o,isDragActive:d}=(0,x.VB)({onDrop:r,accept:t,multiple:!0});return(0,g.jsx)("div",(0,s.A)((0,s.A)({},i()),{},{className:"d-flex flex-column align-items-center justify-content-center text-center ".concat(l),children:(0,g.jsxs)("div",{children:[(0,g.jsx)("input",(0,s.A)({},o())),(0,g.jsx)("p",{children:c})]})}))},p=()=>{var e,t,a;const x="https://api.beschaffungsmarkt.com",[p,j]=(0,n.useState)(null),[v,_]=(0,n.useState)(null),[y,w]=(0,n.useState)(""),N=(0,r.Zp)(),{showAlert:b}=(0,o.M)(),F=(0,c.wA)(),S=(0,r.zy)(),{data:k,requestStatus:C,error:M}=(0,c.d4)(e=>e.user),{chatData:D,requestStatus:A,error:P}=(0,c.d4)(e=>e.user_chat);(0,n.useEffect)(()=>{F((0,i.me)())},[F,S]),(0,n.useEffect)(()=>{p&&F((0,l.Vf)())},[p]),console.log("the data -: ",D);const[I,R]=(0,n.useState)([]),[E,L]=(0,n.useState)(null),[J,O]=(0,n.useState)(null),W=null===k||void 0===k?void 0:k._id,[G,T]=(0,n.useState)(),[Z,q]=(0,n.useState)(),[z,H]=(0,n.useState)(""),U=e=>{const t=new Date(e),a=(new Date-t)/1e3;if(a<60)return a<10?"just now":"".concat(Math.floor(a)," seconds ago");const s=a/60;if(s<60)return s<2?"a minute ago":"".concat(Math.floor(s)," minutes ago");const n=s/60;if(n<24)return n<2?"an hour ago":"".concat(Math.floor(n)," hours ago");const c=n/24;if(c<2)return"a day ago";if(c<30)return"".concat(Math.floor(c)," days ago");const l=c/30;if(l<12)return l<2?"a month ago":"".concat(Math.floor(l)," months ago");const r=l/12;return r<2?"a year ago":"".concat(Math.floor(r)," years ago")},V=null===D||void 0===D||null===(e=D.allChatData)||void 0===e?void 0:e.filter(e=>e.title.toLowerCase().includes(z.toLowerCase()));console.log(p);const B=e=>{J&&J.close();const t=new WebSocket("".concat("wss://chat-api.beschaffungsmarkt.com/"));O(t),t.onopen=()=>{t.send(JSON.stringify({type:"authenticate",data:{userId:W,chatId:e}}))},t.onmessage=e=>{const t=JSON.parse(e.data);"reply_message"===t.type&&j(e=>(0,s.A)((0,s.A)({},e),{},{messages:[...e.messages,t.data]}))},t.onclose=()=>console.log("WebSocket Disconnected"),t.onerror=e=>console.log("WebSocket Error:",e)},Y=(0,n.useRef)(null);(0,n.useEffect)(()=>{Y.current&&(Y.current.scrollTop=Y.current.scrollHeight)},[null===p||void 0===p?void 0:p.messages]);const K=e=>{const t=new Date(e),a=new Date,s=t.toLocaleString("en-US",{month:"short",day:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0}),n=a-t,c=Math.floor(n/1e3),l=Math.floor(c/60),r=Math.floor(l/60),i=Math.floor(r/24);let o="";return o=c<60?"".concat(c," sec ago"):l<60?"".concat(l," min ago"):r<24?"".concat(r," hour").concat(r>1?"s":""," ago"):1===i?"a day ago":"".concat(i," days ago"),"".concat(s," (").concat(o,")")};return(0,g.jsxs)("div",{className:"d-flex flex-column align-items-start justify-content-start w-100 p-1",children:[(0,g.jsx)("div",{className:"d-flex align-items-start justify-content-start w-100 dash-message",children:(0,g.jsx)("h2",{children:"Your Messages"})}),(0,g.jsx)("div",{className:"container-fluid p-0 msg-outer-div border p-2",children:(0,g.jsxs)("div",{className:"row g-0 h-100",children:[(0,g.jsx)("div",{className:"col-12 col-md-4 d-flex flex-column pe-2 h-100",children:(0,g.jsxs)("div",{className:"d-flex flex-column w-100 dash-message-box-left",children:[(0,g.jsx)("div",{className:"w-100 py-1 px-2",children:(0,g.jsx)("input",{className:"form-control w-100 message-search",placeholder:"Search...",value:z,onChange:e=>H(e.target.value)})}),(0,g.jsx)("div",{className:"flex-grow-1 overflow-auto h-100",children:(0,g.jsx)("div",{className:"w-100 mt-4 d-flex flex-column align-items-start justify-content-start",children:(null===D||void 0===D||null===(t=D.allChatData)||void 0===t?void 0:t.length)>0&&(0,g.jsx)(g.Fragment,{children:null===V||void 0===V?void 0:V.map((e,t)=>(0,g.jsx)(g.Fragment,{children:(0,g.jsx)("div",{className:"d-flex flex-column w-100 align-items-start justify-content-start border-bottom dash-msg-left ".concat(v===e._id?"dash-msg-left-active":"dash-msg-left"),onClick:()=>(async e=>{_(e._id);try{const t=await d.A.post("".concat(x,"/api/messages"),{chatId:e._id,itemsPerPage:20,lastMessageCreatedTime:"",page:1},{withCredentials:!0});j({chat_info:e,messages:t.data.slice().reverse()}),J&&J.close(),B(e._id)}catch(c){var t,a,s,n;const e=(null===(t=c.response)||void 0===t||null===(a=t.data)||void 0===a?void 0:a.msg)||(null===(s=c.response)||void 0===s||null===(n=s.data)||void 0===n?void 0:n.error)||c.message||"Something went wrong";b((0,g.jsxs)("div",{className:"d-flex align-items-center justify-content-start gap-1",children:[(0,g.jsx)(f._Jm,{className:"text-danger fs-3"}),e]}),"danger")}})(e),children:(0,g.jsxs)("div",{className:"d-flex align-items-start justify-content-between w-100 ",children:[(0,g.jsxs)("div",{className:"d-flex flex-column align-items-start justify-content-start",children:[(0,g.jsx)("h3",{children:e.title}),e.sender._id===k._id?(0,g.jsx)(g.Fragment,{children:e.receiver.contact_first_name&&e.receiver.contact_last_name?(0,g.jsx)(g.Fragment,{children:(0,g.jsxs)("span",{children:[e.receiver.contact_first_name," ",e.receiver.contact_last_name]})}):(0,g.jsx)(g.Fragment,{children:(0,g.jsx)("span",{children:e.receiver.company_name})})}):(0,g.jsx)(g.Fragment,{children:e.sender.contact_first_name&&e.sender.contact_last_name?(0,g.jsx)(g.Fragment,{children:(0,g.jsxs)("span",{children:[e.sender.contact_first_name," ",e.sender.contact_last_name]})}):(0,g.jsx)(g.Fragment,{children:(0,g.jsx)("span",{children:e.sender.company_name})})})]}),(0,g.jsxs)("div",{className:"d-flex flex-column align-items-end justify-content-start",children:[(0,g.jsx)("span",{className:"display_time",children:U(e.created_time)}),0!=e.unreadMsg&&(0,g.jsx)(g.Fragment,{children:(0,g.jsx)("span",{className:"display_num_msg",children:e.unreadMsg})})]})]})},t)}))})})})]})}),(0,g.jsx)("div",{className:"col-12 col-md-8 d-flex flex-column ",style:{height:"100%"},children:p&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{className:"",children:(0,g.jsx)("div",{className:"d-flex flex-column align-items-start justify-content-start w-100 p-1 dash-chat-outer-div",children:(0,g.jsxs)("div",{className:"dash-right-msg-top w-100 d-flex flex-column align-items-start gap-2 py-3",children:[(0,g.jsx)("h1",{children:p.chat_info.title}),(0,g.jsx)("button",{className:"",onClick:()=>N("/company/".concat(p.chat_info.sender._id)),children:p.chat_info.sender.contact_first_name&&p.chat_info.sender.contact_last_name?(0,g.jsx)(g.Fragment,{children:(0,g.jsxs)("span",{children:[p.chat_info.sender.contact_first_name," ",p.chat_info.sender.contact_last_name]})}):(0,g.jsx)(g.Fragment,{children:(0,g.jsx)("span",{children:p.chat_info.sender.company_name})})})]})})}),(0,g.jsx)("div",{className:"flex-grow-1 overflow-auto ",ref:Y,children:(0,g.jsx)("div",{className:"dash-right-msg-chat-box w-100 d-flex flex-column align-items-start justify-content-end pb-3 ",children:(0,g.jsx)("div",{className:"d-flex flex-column justify-content-end align-items-end h-100 w-100",children:null===p||void 0===p||null===(a=p.messages)||void 0===a?void 0:a.map((e,t)=>(0,g.jsx)(g.Fragment,{children:(0,g.jsxs)("div",{className:"chat-inner-box w-100 d-flex flex-column align-items-start justify-content-start",children:[(0,g.jsxs)("div",{className:"chat-box-profile d-flex flex-row align-items-start justify-content-start gap-2",children:[(0,g.jsx)("img",{src:e.sender===p.chat_info.sender._id?p.chat_info.sender.contact_img?"".concat(x,"/files/").concat(p.chat_info.sender.contact_img):"/Images/user-avatar-CZ6R_fL7.webp":p.chat_info.receiver.contact_img?"".concat(x,"/files/").concat(p.chat_info.receiver.contact_img):"/Images/user-avatar-CZ6R_fL7.webp",alt:""}),(0,g.jsx)("div",{className:"chat-inner-box-id d-flex flex-column align-items-start justify-content-start",children:e.sender===p.chat_info.sender._id?p.chat_info.sender.contact_first_name?(0,g.jsxs)(g.Fragment,{children:[(0,g.jsxs)("label",{children:[p.chat_info.sender.contact_first_name," ",p.chat_info.sender.contact_last_name]}),(0,g.jsx)("span",{children:p.chat_info.sender.contact_email})]}):(0,g.jsx)(g.Fragment,{children:(0,g.jsx)("label",{children:p.chat_info.sender.company_name})}):p.chat_info.receiver.contact_first_name?(0,g.jsxs)(g.Fragment,{children:[(0,g.jsxs)("label",{children:[p.chat_info.receiver.contact_first_name," ",p.chat_info.receiver.contact_last_name]}),(0,g.jsx)("span",{children:p.chat_info.receiver.contact_email})]}):(0,g.jsx)(g.Fragment,{children:(0,g.jsx)("label",{children:p.chat_info.receiver.company_name})})})]}),(0,g.jsxs)("div",{className:"chat-box-text d-flex flex-column align-items-start justify-content-start w-100",children:[(0,g.jsxs)("span",{children:[e.message," "]}),(null===e||void 0===e?void 0:e.file.length)>0&&(0,g.jsx)(g.Fragment,{children:(0,g.jsx)("div",{className:"d-flex flex-wrap align-items-start justify-content-start w-100 gap-3 mt-3",children:null===e||void 0===e?void 0:e.file.map((e,t)=>(0,g.jsx)(g.Fragment,{children:(0,g.jsx)("div",{onClick:()=>{const t=document.createElement("a");t.href="".concat("https://chat-api.beschaffungsmarkt.com","/files/").concat(e),t.download=e,document.body.appendChild(t),t.click(),document.body.removeChild(t)},className:"chat-box-text-file d-flex flex-column align-items-start justify-content-start text-start gap-1",children:(0,g.jsxs)("div",{className:"chat-box-text-file-inner d-flex flex-column align-items-start justify-content-start",children:[(0,g.jsx)(h.FaRegFolder,{className:"fs-5 text-secondary"}),(0,g.jsx)("span",{children:e})]})},t)}))})})]}),(0,g.jsx)("div",{className:"chat-box-date d-flex align-items-start justify-content-end w-100",children:(0,g.jsxs)("span",{children:[K(e.created_time)," "]})})]})}))})})}),(0,g.jsxs)("div",{className:"dash-right-msg-chat-input w-100 d-flex flex-column align-items-start justify-content-start py-2 gap-3",children:[I.length>0&&(0,g.jsx)("div",{className:"dash-msg-selected-file d-flex flex-wrap align-items-start justify-content-start w-100 gap-3 px-2",children:I.map((e,t)=>(0,g.jsxs)("div",{className:"dash-msg-file position-relative d-flex flex-column align-items-start justify-content-start text-start gap-1 p-2",children:[(0,g.jsx)("button",{onClick:()=>(e=>{R(t=>t.filter((t,a)=>a!==e))})(t),className:"position-absolute top-0 end-0 btn p-0 m-1 me-2",style:{background:"transparent",border:"none",fontSize:"16px",cursor:"pointer",color:"dark",lineHeight:"1"},children:"x"}),(0,g.jsx)(h.FaRegFolder,{className:"fs-5 text-secondary"}),(0,g.jsx)("span",{className:"me-2",children:e.name},t)]}))}),(0,g.jsx)("textarea",{rows:3,className:"form-control w-100",placeholder:"Type your reply here...",value:y,onChange:e=>w(e.target.value)}),(0,g.jsxs)("div",{className:"d-flex flex-row align-items-start justify-content-between w-100 px-2",children:[(0,g.jsx)(u,{accept:{"image/*":[".jpg",".jpeg",".png"],"application/pdf":[".pdf"]},onFileDrop:e=>{const t=["jpg","jpeg","png","pdf"],a=[];e.forEach(e=>{const s=e.name.split(".").pop().toLowerCase();t.includes(s)?a.push(e):b("Invalid file: ".concat(e.name,". Only JPG, JPEG, PNG, PDF allowed."),"warning")}),R(e=>[...e,...a])},className:"p-0",label:(0,g.jsx)(g.Fragment,{children:(0,g.jsx)(m.GrAttachment,{className:"fs-4 text-secondary"})})}),(0,g.jsx)("button",{className:"das-button-end save-button",onClick:async()=>{if(!y.trim()&&0===I.length)return void b("Write a message or attach a file!","warning");if(!J||J.readyState!==WebSocket.OPEN)return void b("Socket is not connected!","warning");const e=await Promise.all(I.map(e=>(e=>new Promise((t,a)=>{const s=new FileReader;s.onload=()=>t(s.result.split(",")[1]),s.onerror=a,s.readAsDataURL(e)}))(e))),t=I.map(e=>e.name.split(".").pop().toLowerCase());J.send(JSON.stringify({type:"reply_message",data:{chatId:v,senderId:W,message:y||"",file:e.length>0?e:null,fileType:t.length>0?t:null}})),w(""),R([])},children:"Reply"})]})]})]})})]})})]})}}}]);
//# sourceMappingURL=374.84a8629e.chunk.js.map